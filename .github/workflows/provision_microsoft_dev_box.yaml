name: Manage Microsoft Dev Box

on:
  workflow_dispatch:
    inputs:
      devCenterName:
        description: 'Dev Center Name'
        required: true
      projectName:
        description: 'Project name'
        required: true
      devBoxName:
        description: 'Dev Box Name'
        required: true
      region:
        description: 'Region'
        required: true
      resourceGroupName:
        description: 'Resource Group Name'
        required: true
      imageId:
        description: 'Image ID'
        required: true  
      repo:
        description: 'Repo name'
        required: true
      owner:
        description: 'owner of repo'
        required: true         
jobs:
  deploy-cluster:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Main Repository
      uses: actions/checkout@v3
    
    - name: Checkout dev box github repository 
      uses: actions/checkout@v3
      with:
        repository: ${{ github.event.inputs.owner }}/${{ github.event.inputs.repo }}  
        path: ${{ github.event.inputs.repo }} 
        token: ${{ secrets.MYGITHUB_TOKEN }}

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create parameters.json file
      run: |
        echo '{
          "devCenterName": {
            "value": "'${{ github.event.inputs.devCenterName }}'"
          },
          "region": {
            "value": "'${{ github.event.inputs.region }}'"
          },
          "projectName": {
            "value": "'${{ github.event.inputs.projectName }}'"
          },

          "devBoxName": {
            "value": "'${{ github.event.inputs.devBoxName }}'"
          },

          
          "imageId": {
            "value": "'${{ github.event.inputs.imageId }}'"
          },

        }' > parameters.json


    - name: Deploy Bicep to Provision Microsoft Dev Box
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        resourceGroupName: ${{ github.event.inputs.resourceGroupName }}
        template: './${{ github.event.inputs.repo }}/devbox.bicep' # Reference the Bicep file from the external repo
        parameters: '@parameters.json'
        deploymentMode: Incremental

    - name: Output Dev Box Details
      run: echo "Dev Box ${{ github.event.inputs.devBoxName }} provisioned in region ${{ github.event.inputs.region }}"
